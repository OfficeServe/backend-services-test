machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
    - sudo pip install --upgrade pip
    - sudo pip install docker-compose
  # pre:
  #   - git clone git@github.com:OfficeServe/sbt-settings.git
  #   - chmod +x sbt-settings/./circleBuildScript.sh
  #   - sbt-settings/./circleBuildScript.sh machine_pre
  timezone: UTC
  java:
    version: oraclejdk8
  services:
    - docker

# Collect build artifacts
general:
  artifacts:
    - target/universal

dependencies:
  # Cache the resolution-cache and build streams to speed things up
  pre:
    - wget -q https://dl.bintray.com/sbt/debian/sbt-0.13.13.deb
    - sudo dpkg -i sbt-0.13.13.deb
    - docker-compose up -d
    - . ./setup-env.sh
  cache_directories:
    - "~/.ivy2"
    - "~/.sbt"
    - "/var/lib/docker"

test:
  override:
    # - ../sbt-settings/circleBuildScript.sh run_tests && sbt it:test
    - sbt test package
    #- sbt compile it:test
  # Copy test reports to Circle test reports dir then package app for deploy
  # post:
  #   - cd .. ; sbt-settings/./circleBuildScript.sh copy_test_report

deployment:
  all:
    branch: /release\/.*/
    commands:
      - export projectVersion=$(sed 's/version in ThisBuild := \"\(.*\)\".*/\1/' backend-services-test/version.sbt)
      - export docker_tag="${projectVersion}-${CIRCLE_BUILD_NUM}"
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASSWORD
      - sbt "project basket" docker:stage     && docker build -t officeserve/basket-service:$docker_tag basket-service/target/docker/stage/
      - sbt "project document" docker:stage   && docker build -t officeserve/document-service:$docker_tag document-service/target/docker/stage/
      - sbt "project report" docker:stage     && docker build -t officeserve/report-service:$docker_tag report-service/target/docker/stage/
      - sbt "project sendEmail" docker:stage  && docker build -t officeserve/send-email-lambda:$docker_tag send-email-lambda/target/docker/stage/
      - docker push officeserve/basket-service
      - docker push officeserve/document-service
      - docker push officeserve/report-service
      #- docker push officeserve/send-email-lambda
